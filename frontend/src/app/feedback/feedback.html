<div class="feedback-container">
  <h1>üó£Ô∏è Citizen Feedback</h1>

  @if (!isAdmin) {
  <div class="submit-section">
    <div class="card">
      <h2>Submit Feedback</h2>
      <p class="subtitle">We value your opinion! Please share your thoughts, suggestions, or concerns about the Barangay.</p>

      @if (showSuccessAlert && successMessage) {
      <div class="success-alert">
        <strong>‚úì Success!</strong> {{ successMessage }}
      </div>
      }

      @if (formErrors['general']) {
      <div class="error-message">{{ formErrors['general'] }}</div>
      }

      <div class="form-group">
        <label>Your Message *</label>
        <textarea
          [(ngModel)]="message"
          name="message"
          rows="6"
          placeholder="Type your message here (min. 10 characters)..."
          [class.error]="formErrors['message']"
          [disabled]="isSubmitting"
        ></textarea>
        @if (formErrors['message']) {
        <span class="error-text">{{ formErrors['message'] }}</span>
        }
      </div>

      <div class="form-actions">
        <button (click)="submitFeedback()" class="btn-primary" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Submitting...' : 'Submit Feedback' }}
        </button>
      </div>
    </div>
  </div>
  }

  @if (isAdmin) {
  <div class="admin-section">
    <div class="admin-header">
      <h2>üì• Incoming Feedback</h2>
      <div class="search-bar">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          placeholder="üîç Search feedback..."
          class="search-input"
        />
      </div>
    </div>

    @if (isLoading) {
    <div class="loading">Loading feedback...</div>
    } @else if (error) {
    <div class="error">{{ error }}</div>
    } @else if (filteredFeedback.length === 0) {
    <div class="no-feedback">
      @if (searchQuery) {
      <p>No feedback found matching "{{ searchQuery }}"</p>
      } @else {
      <p>No feedback submitted yet.</p>
      }
    </div>
    } @else {
    <div class="feedback-list">
      @for (item of filteredFeedback; track item.id) {
      <div class="feedback-card" [class.replied]="item.adminReply">
        <div class="card-header">
                <span class="sender-name">
                  {{ item.user?.fullName || 'Anonymous' }}
                  <span class="sender-email">({{ item.user?.email }})</span>
                </span>
          <span class="date">{{ formatDate(item.submittedAt) }}</span>
        </div>

        <div class="message-body">
          {{ item.message }}
        </div>

        @if (item.adminReply) {
        <div class="admin-reply-box">
          <div class="reply-header">
            <strong>‚úÖ Admin Replied:</strong>
            @if (item.repliedAt) {
            <span class="reply-date">{{ formatDate(item.repliedAt) }}</span>
            }
          </div>
          <p>{{ item.adminReply }}</p>
        </div>
        }

        <div class="admin-actions">
          @if (replyingTo === item.id) {
          <div class="reply-form">
                    <textarea
                      [(ngModel)]="replyText[item.id]"
                      placeholder="Type your reply here..."
                      rows="3"
                    ></textarea>
            <div class="reply-buttons">
              <button (click)="submitReply(item.id)" class="btn-primary">Send Reply</button>
              <button (click)="cancelReply()" class="btn-secondary">Cancel</button>
            </div>
          </div>
          } @else {
          <div class="button-group">
            <button (click)="startReply(item.id)" class="btn-reply">
              {{ item.adminReply ? 'Edit Reply' : 'Reply' }}
            </button>
            <button (click)="deleteFeedback(item.id)" class="btn-delete">Delete</button>
          </div>
          }
        </div>
      </div>
      }
    </div>
    }
  </div>
  }
</div>
